调用函数发生了啥
假如我们用钱包账户调用了合约的一个 function，那么这个 function 的执行过程是怎样的？


<img width="1147" height="507" alt="image" src="https://github.com/user-attachments/assets/a9a0a874-afb2-4755-b0c2-2ebfeaaa0c40" />


让我根据这张图详细解释合约函数的执行流程：
1. Transaction 交易输入
```
Transaction {
    from: 钱包地址,
    to: 合约地址,
    value: 转账金额,
    data: 函数选择器 + 参数,
    gasLimit: Gas上限,
    gasPrice: Gas价格,
    nonce: 交易序号
}
```

3. Message 层处理
- 验证交易基本信息
- 签名验证
- nonce 检查
- 基本格式验证
- 创建 Message 对象
```
Message {
      sender: msg.sender,
      recipient: to,
      value: msg.value,
      data: 调用数据,
      gas: gasLimit
  }
```

3. GasPool 处理
-  预扣除交易费用
- 跟踪 gas 使用情况
- 确保 gas 限制在区块范围内
- 准备 gas 退款机制

4. EVM 执行环境准备
```
// Context 上下文
Context {
    blockNumber: 当前区块号,
    timestamp: 时间戳,
    coinbase: 矿工地址,
    difficulty: 难度值,
    gasLimit: 区块gas限制
}

// Config 配置
Config {
    chainId: 链ID,
    homesteadBlock: 硬分叉配置,
    byzantiumBlock: 硬分叉配置,
    // ... 其他配置
}
```

5. StateDB 交互
- 初始状态读取
```
 // 读取合约状态
  StateDB.getState(contractAddress) {
      code: 合约代码,
      storage: 存储数据,
      balance: 余额,
      nonce: 交易计数
  }
```

6. Interpreter 解释执行
```
Interpreter {
    // 1. 函数选择器匹配
    bytes4 selector = msg.data[0:4];
    
    // 2. 参数解码
    params = abi.decode(msg.data[4:]);
    
    // 3. 执行操作码
    while (有操作码) {
        执行当前操作码;
        更新程序计数器;
        检查 gas 消耗;
    }
    
    // 4. 状态更新
    StateDB.updateState(changes);
}
```

7. StateDB 状态更新
```
// 写入新状态
StateDB.commit() {
    更新账户状态;
    更新存储数据;
    计算新的状态根;
    持久化数据;
}
```

这个执行流程展示了从交易输入到最终状态更新的完整过程，每个组件都有其特定的职责：
1. Message 处理交易的基本验证和封装
2. GasPool 管理执行资源
3. EVM 提供执行环境
4. StateDB 负责状态管理
5. Interpreter 执行具体的合约代码
